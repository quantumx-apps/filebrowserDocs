# PR validation workflow for Hugo site
# This workflow calls makefile targets to ensure consistency between local and CI/CD validation
name: PR Checks - Comprehensive Validation

on:
  pull_request:
    branches: ["main"]
  # Allow manual runs for testing
  workflow_dispatch:

# Cancel in-progress runs when a new run is triggered on the same PR
concurrency:
  group: pr-checks-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Setup job - prepare dependencies for all checks
  setup:
    name: Setup Environment
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: 'latest'
          extended: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          # Install yq for YAML validation
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          # Install npm dependencies
          npm install

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            ~/.cache/hugo_cache
          key: ${{ runner.os }}-deps-${{ hashFiles('**/package-lock.json') }}

      - name: Check versions
        run: |
          echo "Hugo version:"
          hugo version
          echo ""
          echo "Node version:"
          node --version
          echo ""
          echo "npm version:"
          npm --version
          echo ""
          echo "yq version:"
          yq --version

  # Parallel check jobs
  check-frontmatter:
    name: Check YAML Front Matter
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
      - name: Run check
        run: make check-frontmatter

  check-frontmatter-fields:
    name: Check Required Fields
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
      - name: Run check
        run: make check-frontmatter-fields

  check-hugo-build:
    name: Hugo Build (Strict)
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: 'latest'
          extended: true
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install npm dependencies
        run: npm install
      - name: Run check
        run: make build-strict

  check-hugo-audit:
    name: Hugo Audit
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: 'latest'
          extended: true
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install npm dependencies
        run: npm install
      - name: Run check
        run: make hugo-audit

  check-doclinks:
    name: Check Doclinks
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install npm dependencies
        run: npm install
      - name: Run check
        run: make check-doclinks

  check-internal-links:
    name: Check Internal Links
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Run check
        run: make check-internal-links

  check-images:
    name: Check Image References
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Run check
        run: make check-images

  check-external-links:
    name: Check External Links
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Run check
        run: make check-external-links

  check-no-todos:
    name: Check TODO/FIXME Markers
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Run check
        run: make check-no-todos

  # Summary job - runs after all checks complete
  summary:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs:
      - check-frontmatter
      - check-frontmatter-fields
      - check-hugo-build
      - check-hugo-audit
      - check-doclinks
      - check-internal-links
      - check-images
      - check-external-links
      - check-no-todos
    steps:
      - name: Summary
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "✅ ALL VALIDATION CHECKS PASSED!"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          echo "✓ Front matter YAML syntax valid"
          echo "✓ Required front matter fields present"
          echo "✓ Hugo build successful with strict validation"
          echo "✓ Hugo audit passed"
          echo "✓ Doclinks validated"
          echo "✓ Internal links validated"
          echo "✓ Image references validated"
          echo "✓ External links validated"
          echo "✓ No TODO/FIXME markers"